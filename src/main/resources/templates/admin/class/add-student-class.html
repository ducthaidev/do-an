<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Thêm Sinh Viên Vào Lớp Chuyên Ngành</title>

  <!-- Custom fonts for this template-->
  <link th:href="@{/static/admin/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
  <link
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet">

  <!-- Custom styles for this template-->
  <link th:href="@{/static/admin/css/sb-admin-2.min.css}" rel="stylesheet">
  <script th:src="@{/static/admin/vendor/jquery/jquery.min.js}"></script>
  <!---react-->
  <script src="/static/js/reactjs/polyfill.js"></script>
  <script
    crossorigin
    src="/static/js/reactjs/react.development.js"
  ></script>
  <script
    crossorigin
    src="/static/js/reactjs/react-dom.development.js"
  ></script>
  <script src="/static/js/reactjs/babel.min.js"></script>
  <script src="/static/js/axios.min.js"></script>
  <link href="/static/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="/static/js/tabulator.min.js"></script>
  <script src="/static/js/xlsx.full.min.js"></script>
</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

  <!-- Sidebar -->
  <div th:replace="~{admin/fragments/side-bar :: sidebar}"></div>
  <!-- End of Sidebar -->

  <!-- Content Wrapper -->
  <div id="content-wrapper" class="d-flex flex-column">

    <!-- Main Content -->
    <div id="content">

      <!-- Topbar -->
      <div th:replace="~{/admin/fragments/navbar :: navbar}"></div>
      <!-- End of Topbar -->

      <!-- Begin Page Content -->
      <div class="container-fluid">
        <h1 className="h3 mb-4 text-gray-800"></h1>
        <!-- Page Heading -->
        <div id="app"></div>
        <script type="text/babel">
          function App() {
            const [students, setStudents] = React.useState(null)
            const [student, setStudent] = React.useState(null)
            const [sessions, setSessions] = React.useState(null)
            const [classes, setClasses] = React.useState(null)
            const [changingClass, setChangingClass] = React.useState(null)
            const [tabulator, setTabulator] = React.useState(null)

            const sessionInputRef = React.useRef()
            const classInputRef = React.useRef()
            const studentTableRef = React.useRef()
            const changingRef = React.useRef()
            const classChangeInputRef = React.useRef()

            React.useEffect(() => {
              Promise.all([getSession()])
                .then(([sessionArr]) => {
                  setSessions(sessionArr)
                })
            }, []);
            React.useEffect(() => {
              if (sessions) {
                getGeneralClassesWithSession(sessionInputRef.current.value)
                  .then((classes) => {
                    setClasses(classes)
                  })
                  .catch(err => console.log(err))
              }
            }, [sessions])
            React.useEffect(() => {
              if (students) {
                while (studentTableRef.current.firstElementChild) {
                  studentTableRef.current.removeChild(studentTableRef.current.firstChild)
                }
                setTabulator(getTabulator())
              }
            }, [students]);

            // data
            const getSession = () => axios.get('/admin/sessions')
            const getGeneralClassesWithSession = (sessionId) => {
              return axios.get(`/api/classes?sessionId=${sessionId}`)
            }
            const getStudents = (classId) => {
              return axios.get(`/api/admin/students?classId=${classId}`)
            }
            const getChangingClass = (sessionId) => {
              return axios.get(`/api/specializedClass?sessionId=${sessionId}`)
            }

            // onChange
            const sessionInputChange = () => {
              studentTableRef.current.removeAttribute('class')
              while (studentTableRef.current.firstElementChild) {
                studentTableRef.current.removeChild(studentTableRef.current.firstChild)
              }
              if (sessions) {
                getGeneralClassesWithSession(sessionInputRef.current.value)
                  .then((classes) => {
                    setClasses(classes)
                  })
                  .catch(err => console.log(err))
              }
            }

            // onSubmit
            const handleFind = (e) => {
              e.preventDefault()
              if (classInputRef.current.value !== "") {
                getStudents(classInputRef.current.value)
                  .then((students) => {
                    setStudents(students)
                  })
                  .catch((err) => {
                    console.log(err)
                  })
                if (studentTableRef.current.hasAttribute("class")) {
                  studentTableRef.current.removeAttribute("class")
                }
              }
            }
            const onAdd = (e) => {
              e.preventDefault()
              console.log(student)
              axios({
                method: 'POST',
                url: `/api/admin/studentClass`,
                headers: {
                  'Content-Type': 'application/json'
                },
                data: {
                  studentId: student.id,
                  classId: parseInt(classChangeInputRef.current.value),
                }
              })
                .then(() => {
                  alert('Thêm Thành Công')
                  location.reload()
                })
                .catch(err => {
                  alert('Thêm Thất Bại ' + err)
                  location.reload()
                })
            }

            // option
            const sessionOption = (sessionData) => {
              return sessionData.map((session) => <option key={session.id} value={session.id}>{session.name}</option>)
            }
            const classOption = (classData) => classData.map((clazz) => {
              return (
                <option key={clazz.id} value={clazz.id}>{clazz.name}</option>
              )
            })
            // utils
            const getTabulator = () => {
              const table = new Tabulator("#student-table", {
                // height: 205
                data: students, //assign data to table
                layout: "fitColumns", //fit columns to width of table (optional)
                columns: [ //Define Table Columns
                  {title: "Họ", field: "firstName"},
                  {title: "Tên", field: "lastName"},
                  {title: "Ngày Sinh", field: "birth"},
                  {title: "Nơi Sinh", field: "place"},
                  {title: "Số Điện Thoại", field: "phoneNumber"},
                ],
                rowClick: function (e, row) {
                  setStudent(row.getData())
                  getChangingClass(sessionInputRef.current.value)
                    .then((classes) => {
                      console.log(classes)
                      setChangingClass(classes)
                    })
                    .catch(err => console.log(err))
                },
              })
              if (students.length > 0) {
                //trigger download of data.csv file
                document.getElementById("download-csv").addEventListener("click",
                  () => {
                    table.download("csv", "data-" + Math.random().toString().replace('0\.', '') + ".csv")
                  });
                //trigger download of data.xlsx file
                document.getElementById("download-xlsx").addEventListener("click", () =>
                  table.download("xlsx", "data-" + Math.random().toString().replace('0\.', '') + ".xlsx",
                    {sheetName: "Data"}));
              }
            }
            return (
              <div>
                <h1 className="h3 mb-4 text-gray-800">Thêm Sinh Viên Vào Lớp Chuyên Ngành</h1>
                <form name="addStudent" onSubmit={handleFind}>
                  <div className="form-group">
                    <label>Khoá</label>
                    <select className="form-control" id="sessionInput" onChange={sessionInputChange}
                            ref={sessionInputRef}>
                      {sessions && sessionOption(sessions)}
                    </select>
                  </div>
                  <div className="form-group">
                    <label>Lớp Đại Cương</label>
                    <select className="form-control" id="classInput" ref={classInputRef}>
                      {classes && classOption(classes)}
                    </select>
                  </div>
                  <button type="submit" className="btn btn-primary"
                          disabled={!classes}>Tìm
                  </button>
                </form>
                <br/>
                {students && students.length > 0 &&
                <div>
                  <button id="download-csv" className="btn btn-success mr-2 mb-2">Tải CSV(Table)</button>
                  <button id="download-xlsx" className="btn btn-success mb-2">Tải XLSX(Excel)</button>
                </div>
                }
                <div id="student-table" ref={studentTableRef}/>
                <hr/>
                {student &&
                <div id="changing" ref={changingRef}>
                  <form className="form-group" onSubmit={onAdd}>
                    <i>Id</i>
                    <input type="text" className="form-control" value={student.id} disabled/>
                    <i>Tên</i>
                    <input type="text" className="form-control" value={student.lastName} disabled/>
                    <i>Số Điện Thoại</i>
                    <input type="text" className="form-control" value={student.phoneNumber} disabled/>
                    <div className="form-group">
                      <label>Lớp</label>
                      <select className="form-control" id="classInput" ref={classChangeInputRef}>
                        {changingClass && classOption(changingClass)}
                      </select>
                    </div>
                    <button type="submit" className="btn btn-primary"
                            disabled={!classes}>
                      Thêm
                    </button>
                  </form>
                </div>
                }

              </div>
            )
          }

          ReactDOM.render(React.createElement(App), document.getElementById('app'))
        </script>
      </div>
      <!-- /.container-fluid -->

    </div>
    <!-- End of Main Content -->

  </div>
  <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<div th:replace="~{/admin/fragments/logout-modal :: logout}"></div>

<!-- Bootstrap core JavaScript-->
<script th:src="@{/static/admin/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<!-- Core plugin JavaScript-->
<script th:src="@{/static/admin/vendor/jquery-easing/jquery.easing.min.js}"></script>

<!-- Custom scripts for all pages-->
<script th:src="@{/static/admin/js/sb-admin-2.min.js}"></script>
</body>

</html>