<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Admin Pannel</title>

  <!-- Custom fonts for this template-->
  <link th:href="@{/static/admin/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
  <link
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet">

  <!-- Custom styles for this template-->
  <link th:href="@{/static/admin/css/sb-admin-2.min.css}" rel="stylesheet">
  <script th:src="@{/static/admin/vendor/jquery/jquery.min.js}"></script>
  <!---react-->
  <script src="/static/js/reactjs/polyfill.js"></script>
  <script
    crossorigin
    src="/static/js/reactjs/react.development.js"
  ></script>
  <script
    crossorigin
    src="/static/js/reactjs/react-dom.development.js"
  ></script>
  <script src="/static/js/reactjs/babel.min.js"></script>
  <script src="/static/js/axios.min.js"></script>
  <link href="/static/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="/static/js/tabulator.min.js"></script>
  <script src="/static/js/immutable.min.js"></script>
  <script src="/static/js/immutable.js"></script>
</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

  <!-- Sidebar -->
  <div th:replace="~{admin/fragments/side-bar :: sidebar}"></div>
  <!-- End of Sidebar -->

  <!-- Content Wrapper -->
  <div id="content-wrapper" class="d-flex flex-column">

    <!-- Main Content -->
    <div id="content">

      <!-- Topbar -->
      <div th:replace="~{/admin/fragments/navbar :: navbar}"></div>
      <!-- End of Topbar -->

      <!-- Begin Page Content -->
      <div class="container-fluid">
        <h1></h1>
        <!-- Page Heading -->
        <div id="app"></div>
        <script type="text/babel">
          function App() {
            const [departments, setDepartments] = React.useState(null)
            const [lecturers, setLecturers] = React.useState(null)
            const [lecturer, setLecturer] = React.useState(null)
            const [updatingLecturers, setUpdatingLecturers] = React.useState(null)
            const [departmentUpdateInput, setDepartmentUpdateInput] = React.useState(null)

            const departmentInputRef = React.useRef()
            const lecturerInputRef = React.useRef()
            const departmentUpdateInputRef = React.useRef()
            const lecturerUpdateInputRef = React.useRef()

            // effect
            React.useEffect(() => {
              getDepartment()
                .then((departments) => {
                  setDepartments(deepFreeze(departments))
                  setDepartmentUpdateInput(departmentInputRef.current.value)
                })
                .catch(err => console.log(err))
            }, [])
            React.useEffect(() => {
              if (departments) {
                getLecturers(departmentInputRef.current.value)
                  .then((lecturers) => {
                    setLecturers(deepFreeze(lecturers))
                  })
                  .catch(err => console.log(err))
              }
            }, [departments])
            React.useEffect(() => {
              if (lecturers) {
                getLecturer(lecturerInputRef.current.value)
                  .then((lecturer) => {
                    setLecturer(deepFreeze(lecturer))
                  })
                  .catch(err => console.log(err))
              }
            }, [lecturers])

            // change
            const departmentInputChange = () => {
              departmentUpdateInputRef.current.value = departmentInputRef.current.value
              setDepartmentUpdateInput(departmentInputRef.current.value)
              getLecturers(departmentInputRef.current.value)
                .then((lecturers) => {
                  setLecturers(deepFreeze(lecturers))
                })
                .catch(err => console.log(err))
            }
            const lecturerInputChange = () => {
              getLecturer(lecturerInputRef.current.value)
                .then((lecturer) => {
                  lecturerUpdateInputRef.current.value = lecturer.name
                  setLecturer(deepFreeze(lecturer))
                })
                .catch(err => console.log(err))
            }
            const departmentInputUpdateChange = () => {
              // getLecturers(departmentUpdateInputRef.current.value)
              //   .then((lecturers) => {
              //     setLecturers(deepFreeze(lecturers))
              //   })
              //   .catch(err => console.log(err))
            }

            // submit
            const onUpdate = (e) => {
              e.preventDefault()
              axios({
                method: 'PATCH',
                url: `/api/admin/lecturers/${lecturer.id}`,
                headers: {
                  'Content-Type': 'application/json'
                },
                data: {
                  name: lecturerUpdateInputRef.current.value,
                  departmentId: departmentUpdateInputRef.current.value,
                }
              })
                .then(() => {
                  alert('Cập Nhật Thành Công')
                  location.reload()
                })
                .catch(err => {
                  alert('Cập Nhật Thất Bại ' + err)
                  location.reload()
                })
            }

            // get
            const getDepartment = () => axios.get('/api/departments')
            const getLecturers = (departmentId) => {
              return axios.get(
                `/api/admin/lecturers?departmentId=${departmentId}`
              )
            }
            const getLecturer = (id) => {
              return axios.get(`/api/admin/lecturers/${id}`)
            }

            const departmentOption = (departmentData) => departmentData.map((department) => {
              return (
                <option key={department.id} value={department.id}>{department.name}</option>
              )
            })
            const lecturersOption = (lecturerData) => lecturerData.map((lecturer) => {
              return (
                <option key={lecturer.id} value={lecturer.id}>{lecturer.name}</option>
              )
            })
            return (
              <div>
                <h1>Sửa Giảng Viên</h1>
                <form>
                  <div className="form-group">
                    <label htmlFor="departmentInput">Khoa</label>
                    <select className="form-control" id="departmentInput"
                            ref={departmentInputRef} onChange={departmentInputChange}>
                      {departments && departmentOption(departments)}
                    </select>
                  </div>
                  <div className="form-group">
                    <label htmlFor="lecturerInput">Giảng Viên</label>
                    <select className="form-control"
                            ref={lecturerInputRef}
                            onChange={lecturerInputChange}
                            id="lecturerInput">
                      {lecturers && lecturersOption(lecturers)}
                    </select>
                  </div>
                </form>
                <hr/>
                <div>
                  <h3>Thay Đổi Cho: {lecturer && ' Id: ' + lecturer.id + ' - Tên: ' +
                    lecturer.name + ' - Khoa: ' + lecturer.department.name}</h3>
                  <form onSubmit={onUpdate}>
                    <div className="form-group">
                      <label htmlFor="departmentUpdateInput">Khoa</label>
                      <select className="form-control" id="departmentUpdateInput"
                              defaultValue={departmentUpdateInput && departmentUpdateInput}
                              ref={departmentUpdateInputRef} onChange={departmentInputUpdateChange}>
                        {departments && departmentOption(departments)}
                      </select>
                    </div>
                    <div className="form-group">
                      <label htmlFor="lecturerUpdateInput">Giảng Viên</label>
                      <input className="form-control" type="text" id="lecturerUpdateInput"
                             ref={lecturerUpdateInputRef}
                             defaultValue={lecturer && lecturer.name}/>
                    </div>
                    <button type="submit" className="btn btn-primary">Cập Nhật</button>
                  </form>
                </div>
              </div>
            )
          }

          function deepFreeze(object) {
            const propNames = Object.getOwnPropertyNames(object);
            for (const name of propNames) {
              const value = object[name];
              if (value && typeof value === "object") {
                deepFreeze(value);
              }
            }
            return Object.freeze(object);
          }

          ReactDOM.render(React.createElement(App), document.getElementById('app'))
        </script>
      </div>
      <!-- /.container-fluid -->

    </div>
    <!-- End of Main Content -->

  </div>
  <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<div th:replace="~{/admin/fragments/logout-modal :: logout}"></div>

<!-- Bootstrap core JavaScript-->
<script th:src="@{/static/admin/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<!-- Core plugin JavaScript-->
<script th:src="@{/static/admin/vendor/jquery-easing/jquery.easing.min.js}"></script>

<!-- Custom scripts for all pages-->
<script th:src="@{/static/admin/js/sb-admin-2.min.js}"></script>
</body>

</html>